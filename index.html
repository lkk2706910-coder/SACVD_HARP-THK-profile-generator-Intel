<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wafer Map Pro v6 - Fixed Comparison</title>
    <script src="plotly-2.24.1.min.js"></script>
    <script src="tailwindcss.js"></script>
    <style>
        .stats-val { font-variant-numeric: tabular-nums; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        /* Loading animation */
        .spinner { width: 24px; height: 24px; border: 3px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex flex-col">

<header class="bg-white shadow-sm z-10 p-3 flex justify-between items-center shrink-0 border-b border-slate-200">
    <div class="flex items-center gap-3">
        <h1 class="text-lg font-bold text-slate-800 tracking-tight">WAFER MAP <span class="text-blue-600">PRO</span></h1>
        <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded font-mono">SACVD/HARP (49pts)</span>
    </div>
    <div id="slotSelector" class="flex bg-slate-100 p-1 rounded-lg">
        </div>
</header>

<div class="flex flex-1 overflow-hidden">
    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col shrink-0 z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
        <div class="p-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Data Import</h2>
            <textarea id="pasteArea" class="w-full h-20 text-xs font-mono p-2 border border-slate-300 rounded bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition outline-none resize-none" placeholder="Paste Excel column..."></textarea>
            <button onclick="autoExtract()" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded shadow-sm transition flex items-center justify-center gap-2">
                <span>⚡</span> Parse Data
            </button>
        </div>
        
        <div class="flex-1 flex flex-col overflow-hidden">
             <div class="flex justify-between items-center px-4 py-2 bg-slate-50 border-y border-slate-100">
                 <h2 class="text-[10px] font-bold text-slate-500 uppercase">Values (Å)</h2>
                 <span class="text-[10px] font-mono text-slate-400">Slot <span id="currentSlotDisplay" class="font-bold text-blue-600">A</span></span>
             </div>
             <div id="pointInputs" class="flex-1 overflow-y-auto p-2 space-y-1 bg-white">
                 </div>
        </div>
    </aside>

    <main class="flex-1 relative bg-slate-50 flex flex-col overflow-y-auto">
        <div class="flex-1 flex items-center justify-center p-4 min-h-[500px]">
            <div id="waferPlot" class="w-full h-full max-w-[750px] max-h-[750px]"></div>
        </div>

        <div class="bg-white border-t border-slate-200 p-4 shrink-0 z-10">
            <div class="max-w-5xl mx-auto flex flex-col md:flex-row gap-4 items-center justify-between">
                <div id="bottomStats" class="flex gap-4 flex-1 justify-center md:justify-start">
                    </div>
                <button onclick="openComparison()" class="bg-slate-800 hover:bg-black text-white text-sm font-bold px-5 py-2.5 rounded-lg shadow-lg hover:shadow-xl transition transform active:scale-95 flex items-center gap-2 shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    Compare All Slots (5)
                </button>
            </div>
        </div>
    </main>
</div>

<div id="compModal" class="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-50 hidden flex flex-col">
    <div class="flex justify-between items-center px-6 py-4 bg-white/5 border-b border-white/10 shrink-0">
        <div>
            <h2 class="text-xl font-bold text-white tracking-tight">Fleet Analysis View</h2>
            <p class="text-xs text-slate-400">Comparing 5 slots with individual statistics</p>
        </div>
        <button onclick="closeComparison()" class="group bg-white/10 hover:bg-red-500/80 p-2 rounded-full transition">
            <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 md:p-8">
        <div id="compGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6 max-w-[1800px] mx-auto">
            </div>
    </div>
</div>

<script>
    // --- Config ---
    const WAFER_RADIUS = 150; 
    const GRID_RES = 60; 
    
    const config = {
        X: [0.0, 0.0001, -0.0001, 104.6513, -104.6513, -104.652, 104.6522, 128.1713, -128.1713, -128.1719, 128.172, 142.9568, -142.9568, 142.957, -142.957, 148, -148, -0.0002, 34.8837, -34.8837, 34.884, -34.884, 37.7577, -37.7577, 37.7584, -37.7584, 38.3045, -38.3045, 38.3057, -38.3057, 0.0004, 49.3332, -49.3332, 0.0005, -0.0005, 69.7674, -69.7675, -69.768, 69.7681, 73.9993, -73.9993, -74.0003, 74.0005, 91.1559, -91.1559, 91.1562, -91.1562, 98.6666, -98.6666],
        Y: [0.0, -49.3332, 49.3332, 104.6522, -104.6522, 104.6513, -104.6513, 74.0005, -74.0003, 73.9995, -73.9993, 38.3057, -38.3057, -38.3045, 38.3045, 0.0005, -0.0005, 98.6666, 34.884, -34.884, -34.8837, 34.8837, 91.1562, -91.1562, -91.1559, 91.1559, 142.957, -142.957, -142.9568, 142.9568, -98.6666, 0.0001, -0.0001, -148, 148, 69.7681, -69.768, 69.7675, -69.7675, 128.172, -128.1719, 128.1714, -128.1713, 37.7584, -37.7584, -37.7577, 37.7577, 0.0004, -0.0004]
    };

    let currentSlot = 'A';
    let storage = { 'A': [], 'B': [], 'C': [], 'D': [], 'E': [] };

    function init() {
        const selector = document.getElementById('slotSelector');
        ['A','B','C','D','E'].forEach(s => {
            const btn = document.createElement('button');
            btn.id = `btn-${s}`;
            btn.className = `px-4 py-1.5 text-xs font-bold rounded-lg transition-all ${s==='A'?'bg-blue-600 text-white shadow-md ring-2 ring-blue-200':'text-slate-500 hover:bg-slate-200'}`;
            btn.textContent = `Slot ${s}`;
            btn.onclick = () => switchSlot(s);
            selector.appendChild(btn);
            storage[s] = new Array(config.X.length).fill("");
        });
        refreshInputs();
        drawPlot();
    }

    function switchSlot(slot) {
        currentSlot = slot;
        document.getElementById('currentSlotDisplay').textContent = slot;
        document.querySelectorAll('#slotSelector button').forEach(b => b.className = "px-4 py-1.5 text-xs font-bold rounded-lg transition-all text-slate-500 hover:bg-slate-200");
        document.getElementById(`btn-${slot}`).className = "px-4 py-1.5 text-xs font-bold rounded-lg transition-all bg-blue-600 text-white shadow-md ring-2 ring-blue-200";
        refreshInputs();
        drawPlot();
    }

    function updateValue(idx, val) {
        storage[currentSlot][idx] = val;
        if(window.redrawTimeout) clearTimeout(window.redrawTimeout);
        window.redrawTimeout = setTimeout(drawPlot, 200); 
    }

    function refreshInputs() {
        const container = document.getElementById('pointInputs');
        container.innerHTML = '';
        storage[currentSlot].forEach((val, i) => {
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 group";
            div.innerHTML = `
                <span class="text-[10px] font-mono text-slate-300 w-6 text-right group-hover:text-blue-500 transition">#${(i+1).toString().padStart(2,'0')}</span>
                <input type="number" class="w-full bg-slate-50 border border-transparent hover:border-slate-200 focus:border-blue-500 focus:bg-white rounded px-2 py-1 text-xs font-bold text-slate-700 outline-none text-right transition" 
                       value="${val}" oninput="updateValue(${i}, this.value)">
            `;
            container.appendChild(div);
        });
    }

    function autoExtract() {
        const text = document.getElementById('pasteArea').value;
        const numbers = text.match(/[-+]?\d*\.\d+|\d+/g);
        if (!numbers) return;
        const count = config.X.length;
        const target = numbers.length >= count ? numbers.slice(-count) : numbers;
        target.forEach((num, i) => { if(i < count) storage[currentSlot][i] = num; });
        document.getElementById('pasteArea').value = '';
        refreshInputs();
        drawPlot();
    }

    // --- Math & Stats ---
    function interpolateGrid(xPoints, yPoints, zValues, resolution = GRID_RES) {
        const validIndices = zValues.map((v, i) => (v !== "" && !isNaN(v)) ? i : -1).filter(i => i !== -1);
        if (validIndices.length < 3) return null;

        const xGrid = [], yGrid = [], zGrid = [];
        const step = 320 / resolution; 

        for (let i = 0; i <= resolution; i++) {
            const rowZ = [];
            const y = -160 + i * step;
            yGrid.push(y);
            for (let j = 0; j <= resolution; j++) {
                const x = -160 + j * step;
                if (i === 0) xGrid.push(x);
                if (Math.sqrt(x*x + y*y) > WAFER_RADIUS) { rowZ.push(null); continue; }
                
                let num = 0, den = 0, exact = null;
                for (let k of validIndices) {
                    const d = Math.sqrt((x - xPoints[k])**2 + (y - yPoints[k])**2);
                    if (d < 1) { exact = zValues[k]; break; }
                    const w = 1 / Math.pow(d, 3.5);
                    num += zValues[k] * w; den += w;
                }
                rowZ.push(exact !== null ? exact : num / den);
            }
            zGrid.push(rowZ);
        }
        return { x: xGrid, y: yGrid, z: zGrid };
    }

    function calculateStats(vals) {
        const valid = vals.filter(v => v !== "" && !isNaN(v)).map(Number);
        const n = valid.length;
        if (!n) return null;

        const avg = valid.reduce((a,b)=>a+b,0) / n;
        const min = Math.min(...valid), max = Math.max(...valid);
        const rng = max - min;

        // Standard Deviation (Sample)
        let stdDev = 0;
        if (n > 1) {
            const sumSqDiff = valid.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0);
            stdDev = Math.sqrt(sumSqDiff / (n - 1));
        }

        // CV Formula: (StdDev / Mean) * 100
        const uPct = avg ? (stdDev / avg * 100) : 0;

        return { avg, min, max, rng, uPct };
    }

    // --- Plotting ---
    function drawPlot() {
        const vals = storage[currentSlot];
        const gridData = interpolateGrid(config.X, config.Y, vals, 80); 
        const stats = calculateStats(vals);
        const statDiv = document.getElementById('bottomStats');

        if (stats) {
            const item = (lbl, val, unit, color) => `
                <div class="px-4 py-2 bg-slate-50 rounded-lg border border-slate-200 text-center min-w-[100px]">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${lbl}</div>
                    <div class="text-xl font-black ${color||'text-slate-800'}">${val}<span class="text-xs font-normal text-slate-400 ml-0.5">${unit}</span></div>
                </div>`;
            
            // Labels updated to reflect CV if desired
            statDiv.innerHTML = item('THK (Avg)', stats.avg.toFixed(1), 'Å') +
                                item('Range', stats.rng.toFixed(1), 'Å') +
                                item('Uniformity', stats.uPct.toFixed(2), '', 'text-blue-600');
        } else {
            statDiv.innerHTML = `<div class="text-slate-400 font-bold text-sm italic py-2">No data in Slot ${currentSlot}</div>`;
        }

        renderPlotly('waferPlot', gridData, vals, { showPoints: true, pointSize: 10 });
    }

    function renderPlotly(divId, gridData, rawVals, opts = {}) {
        if (!gridData) {
            Plotly.newPlot(divId, [], { xaxis: {visible:false}, yaxis: {visible:false}, title: {text:'No Data', font:{color:'#cbd5e1'}} });
            return;
        }

        const traces = [{
            x: gridData.x, y: gridData.y, z: gridData.z,
            type: 'contour', colorscale: 'Jet', ncontours: 40,
            line: { width: 0 }, contours: { coloring: 'heatmap', showlabels: false },
            zsmooth: 'best', showscale: opts.showScale ?? true,
            colorbar: { title: 'Å', thickness: 15 }
        }];

        if (opts.showPoints) {
            traces.push({
                x: config.X, y: config.Y,
                mode: 'markers+text', type: 'scatter',
                text: rawVals.map(v => v ? Math.round(v) : ''),
                textfont: { size: opts.pointSize || 10, color: 'black', weight: 'bold', family: 'Arial' },
                textposition: 'top center',
                marker: { size: 4, color: 'rgba(0,0,0,0.5)', line: {color: 'white', width: 1} },
                hoverinfo: 'none'
            });
        }

        const layout = {
            margin: { t: 10, b: 10, l: 10, r: 10 },
            xaxis: { range: [-160, 160], visible: false, fixedrange: true },
            yaxis: { range: [-160, 160], visible: false, scaleanchor: "x", fixedrange: true },
            shapes: [{ type: 'circle', x0: -150, y0: -150, x1: 150, y1: 150, line: { color: 'black', width: 2 } }],
            plot_bgcolor: 'rgba(0,0,0,0)', paper_bgcolor: 'rgba(0,0,0,0)'
        };

        Plotly.react(divId, traces, layout, {displayModeBar: false});
    }

    // --- Fixed Fleet Comparison Logic ---
    function openComparison() {
        document.getElementById('compModal').classList.remove('hidden');
        const grid = document.getElementById('compGrid');
        grid.innerHTML = ''; 

        // Create placeholders immediately
        ['A','B','C','D','E'].forEach(slot => {
            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl overflow-hidden shadow-2xl border border-slate-200 flex flex-col h-[420px]";
            card.innerHTML = `
                <div class="bg-slate-50 px-4 py-2 border-b border-slate-100 flex justify-between items-center shrink-0">
                    <span class="font-black text-slate-700 text-lg">Slot ${slot}</span>
                </div>
                <div id="comp-plot-${slot}" class="flex-1 bg-white relative w-full h-full">
                    <div class="absolute inset-0 flex items-center justify-center text-slate-300">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div id="comp-stat-${slot}" class="bg-slate-50 border-t border-slate-100 px-2 py-3 grid grid-cols-3 gap-1 shrink-0">
                    </div>
            `;
            grid.appendChild(card);
        });

        // Execute rendering with staggered timing (Async Loop)
        ['A','B','C','D','E'].forEach((slot, index) => {
            setTimeout(() => {
                try {
                    const plotDiv = document.getElementById(`comp-plot-${slot}`);
                    const vals = storage[slot];
                    const stats = calculateStats(vals);
                    const statFooter = document.getElementById(`comp-stat-${slot}`);
                    
                    if (stats) {
                        // 1. Stats
                        const miniStat = (lbl, val, color) => `
                            <div class="text-center">
                                <div class="text-[9px] font-bold text-slate-400 uppercase">${lbl}</div>
                                <div class="text-sm font-black ${color || 'text-slate-800'}">${val}</div>
                            </div>`;
                        
                        // Using 'Uniformity' label but calculating CV% as requested
                        statFooter.innerHTML = 
                            miniStat('THK', stats.avg.toFixed(0)) +
                            miniStat('Uniformity', stats.uPct.toFixed(2)+'', 'text-blue-600') +
                            miniStat('Range', stats.rng.toFixed(0));

                        // 2. Chart - Force clear spinner first
                        plotDiv.innerHTML = '';
                        
                        const gridData = interpolateGrid(config.X, config.Y, vals, 50);
                        if(gridData) {
                            renderPlotly(`comp-plot-${slot}`, gridData, vals, { showPoints: true, pointSize: 8, showScale: false });
                        } else {
                            plotDiv.innerHTML = `<div class="flex items-center justify-center h-full text-slate-400 text-xs text-center p-4">Not enough points</div>`;
                        }
                        
                    } else {
                        // Empty Data
                        statFooter.innerHTML = `<div class="col-span-3 text-center text-xs text-slate-300 font-bold py-1">NO DATA</div>`;
                        plotDiv.innerHTML = `<div class="flex items-center justify-center h-full text-slate-300 font-bold text-sm">Empty</div>`;
                    }
                } catch (e) {
                    console.error("Render error slot " + slot, e);
                    document.getElementById(`comp-plot-${slot}`).innerHTML = `<div class="flex items-center justify-center h-full text-red-400 font-bold text-xs">Error</div>`;
                }
            }, 100 + (index * 200)); // Stagger: 100ms, 300ms, 500ms...
        });
    }

    function closeComparison() {
        document.getElementById('compModal').classList.add('hidden');
    }

    window.onload = init;
</script>
</body>
</html>